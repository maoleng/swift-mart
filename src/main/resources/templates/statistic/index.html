<!DOCTYPE html>
<html lang="en">
<div th:replace="theme/head-tag :: headTag"></div>
<link rel="stylesheet" type="text/css" th:href="@{/assets/css/vendors/datatables.css}">
<link rel="stylesheet" type="text/css" th:href="@{/assets/css/vendors/datatable-extension.css}">
<link rel="stylesheet" type="text/css" th:href="@{/assets/css/vendors/flatpickr.min.css}">

<div th:replace="theme/app-style :: appStyle"></div>
<body>
<div th:replace="theme/loader :: loader"></div>
<div class="page-wrapper compact-sidebar compact-small material-icon" id="pageWrapper">
    <div th:replace="theme/header :: header"></div>
    <div th:replace="theme/menu :: menu"></div>
    <div class="page-body-wrapper">
        <div th:replace="theme/menu-sidebar :: menuSidebar"></div>
        <div class="page-body">
            <div class="container-fluid">
                <div class="page-title">
                    <div class="row">
                        <div class="col-12 col-sm-6 p-0">
                            <h3>Statisic</h3>
                        </div>
                        <div class="col-12 col-sm-6 p-0">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a href="/">
                                        <svg class="stroke-icon">
                                            <use th:href="@{/assets/svg/icon-sprite.svg#breadcrumb-home}"></use>
                                        </svg>
                                    </a>
                                </li>
                                <li class="breadcrumb-item">Home</li>
                                <li class="breadcrumb-item active">Statisic</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-xxl-3 col-xl-4 box-col-4">
                        <div class="md-sidebar">
                            <a class="btn btn-primary email-aside-toggle md-sidebar-toggle b-r-10">Filter Time</a>
                            <div class="md-sidebar-aside job-sidebar">
                                <div class="default-according style-1 faq-accordion job-accordion">
                                    <div class="accordion" id="accordionExample">
                                        <div class="card">
                                            <div class="card-header" id="headingOne">
                                                <h2 class="mb-0">
                                                    <button class="btn btn-link btn-block text-start" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">Filter</button>
                                                </h2>
                                            </div>
                                            <div class="collapse show" id="collapseOne" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                                                <div class="card-body filter-cards-view animate-chk">
                                                    <div class="checkbox-animated">
                                                        <label class="d-block" for="iYesterday">
                                                            <input class="checkbox_animated" name="date" id="iYesterday" value="yesterday" type="radio"> Yesterday
                                                        </label>
                                                        <label class="d-block" for="iToday">
                                                            <input class="checkbox_animated" name="date" id="iToday" value="today" type="radio"> Today
                                                        </label>
                                                        <label class="d-block" for="iWeek">
                                                            <input class="checkbox_animated" name="date" id="iWeek" value="week" type="radio">7 days
                                                        </label>
                                                        <label class="d-block" for="iMonth">
                                                            <input class="checkbox_animated" name="date" id="iMonth" value="month" type="radio">This months
                                                        </label>
                                                        <label class="d-block" for="iCustom">
                                                            <input class="checkbox_animated" name="date" id="iCustom" value="custom" type="radio">Custom
                                                        </label>
                                                    </div>
                                                    <div class="job-filter pb-5">
                                                        <div class="faq-form">
                                                            <input class="form-control" hidden id="range-date" type="date">
                                                            <i class="search-icon" data-feather="time"></i>
                                                        </div>
                                                    </div>
                                                    <button id="btn-filter" class="btn btn-primary text-center" type="button">Filter</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="col-xxl-9 col-xl-8 box-col-7">
                        <div class="row">
                            <div class="col-xxl-4 col-xl-8 box-col-7">
                                <div class="card profit-card">
                                    <div class="card-header card-no-border">
                                        <div class="d-flex justify-content-between">
                                            <div class="flex-grow-1">
                                                <h3>Orders</h3>
                                                <h2 class="pt-3" th:text="${orderCount}"></h2>
                                            </div>
                                            <div class="flex-shrink-0"> <img th:src="@{/assets/images/dashboard-2/total-icon/order.png}" alt=""></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xxl-4 col-xl-8 box-col-7">
                                <div class="card profit-card">
                                    <div class="card-header card-no-border">
                                        <div class="d-flex justify-content-between">
                                            <div class="flex-grow-1">
                                                <h3>Revenue</h3>
                                                <h2 class="pt-3 td-money" th:text="${revenue}"></h2>
                                            </div>
                                            <div class="flex-shrink-0">
                                                <svg xmlns="http://www.w3.org/2000/svg" height="32" width="32" viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2023 Fonticons, Inc.--><path fill="#b0b6bf" d="M320 96H192L144.6 24.9C137.5 14.2 145.1 0 157.9 0H354.1c12.8 0 20.4 14.2 13.3 24.9L320 96zM192 128H320c3.8 2.5 8.1 5.3 13 8.4C389.7 172.7 512 250.9 512 416c0 53-43 96-96 96H96c-53 0-96-43-96-96C0 250.9 122.3 172.7 179 136.4l0 0 0 0c4.8-3.1 9.2-5.9 13-8.4zm84 88c0-11-9-20-20-20s-20 9-20 20v14c-7.6 1.7-15.2 4.4-22.2 8.5c-13.9 8.3-25.9 22.8-25.8 43.9c.1 20.3 12 33.1 24.7 40.7c11 6.6 24.7 10.8 35.6 14l1.7 .5c12.6 3.8 21.8 6.8 28 10.7c5.1 3.2 5.8 5.4 5.9 8.2c.1 5-1.8 8-5.9 10.5c-5 3.1-12.9 5-21.4 4.7c-11.1-.4-21.5-3.9-35.1-8.5c-2.3-.8-4.7-1.6-7.2-2.4c-10.5-3.5-21.8 2.2-25.3 12.6s2.2 21.8 12.6 25.3c1.9 .6 4 1.3 6.1 2.1l0 0 0 0c8.3 2.9 17.9 6.2 28.2 8.4V424c0 11 9 20 20 20s20-9 20-20V410.2c8-1.7 16-4.5 23.2-9c14.3-8.9 25.1-24.1 24.8-45c-.3-20.3-11.7-33.4-24.6-41.6c-11.5-7.2-25.9-11.6-37.1-15l0 0-.7-.2c-12.8-3.9-21.9-6.7-28.3-10.5c-5.2-3.1-5.3-4.9-5.3-6.7c0-3.7 1.4-6.5 6.2-9.3c5.4-3.2 13.6-5.1 21.5-5c9.6 .1 20.2 2.2 31.2 5.2c10.7 2.8 21.6-3.5 24.5-14.2s-3.5-21.6-14.2-24.5c-6.5-1.7-13.7-3.4-21.1-4.7V216z"/></svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xxl-4 col-xl-8 box-col-7">
                                <div class="card profit-card">
                                    <div class="card-header card-no-border">
                                        <div class="d-flex justify-content-between">
                                            <div class="flex-grow-1">
                                                <h3>Success Orders</h3>
                                                <h2 class="pt-3" th:text="${successOrderCount}"></h2>
                                            </div>
                                            <div class="flex-shrink-0">
                                                <svg xmlns="http://www.w3.org/2000/svg" height="32" width="32" viewBox="0 0 384 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2023 Fonticons, Inc.--><path fill="#f93e98" d="M192 0c-41.8 0-77.4 26.7-90.5 64H64C28.7 64 0 92.7 0 128V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V128c0-35.3-28.7-64-64-64H282.5C269.4 26.7 233.8 0 192 0zm0 64a32 32 0 1 1 0 64 32 32 0 1 1 0-64zM305 273L177 401c-9.4 9.4-24.6 9.4-33.9 0L79 337c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L271 239c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/></svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xxl-12 card">
                                <div class="card-header card-no-border">
                                    <h3>Transactions</h3>
                                    <div class="card-body">
                                        <div class="dt-ext table-responsive theme-scrollbar">
                                            <table class="display" id="export-button">
                                                <thead>
                                                <tr>
                                                    <th>User</th>
                                                    <th>Sale</th>
                                                    <th>Status</th>
                                                    <th>Total</th>
                                                    <th>Payment Method</th>
                                                    <th>Created At</th>
                                                    <th>Action</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr th:each="order : ${orders}">
                                                    <td data-bs-toggle="modal" th:data-bs-target="'#user-' + ${order.get_id()}" class="btn-hover-effect">
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-grow-1 ms-2">
                                                                <a href="#">
                                                                    <h5 th:text="${order.getUser().getName()}"></h5>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <div class="modal fade" th:id="'user-' + ${order.get_id()}" tabindex="-1" role="dialog" aria-labelledby="exampleModallaptop1" aria-hidden="true">
                                                        <div class="modal-dialog modal-dialog-centered" role="document">
                                                            <div class="modal-content">
                                                                <div class="col-xl-12">
                                                                    <div class="card social-profile mb-0">
                                                                        <div class="card-body">
                                                                            <div class="social-details">
                                                                                <h5 class="mb-1">
                                                                                    <h3 th:text="${order.getUser().getName()}"></h3>
                                                                                </h5>
                                                                                <ul class="social-follow">
                                                                                    <li>
                                                                                        <h5 class="mb-0">Phone</h5><span class="f-light" th:text="${order.getUser().getPhone()}"></span>
                                                                                    </li>
                                                                                    <li>
                                                                                        <h5 class="mb-0">Address</h5><span class="f-light" th:text="${order.getUser().getAddress()}"></span>
                                                                                    </li>
                                                                                </ul>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <td data-bs-toggle="modal" th:data-bs-target="'#sale-' + ${order.get_id()}" class="btn-hover-effect">
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-shrink-0"><img class="img-70" th:src="${order.getSale().getAvatar()}" alt=""></div>
                                                            <div class="flex-grow-1 ms-2">
                                                                <a href="#">
                                                                    <h5 th:text="${order.getSale().getName()}"></h5>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <div class="modal fade" th:id="'sale-' + ${order.get_id()}" tabindex="-1" role="dialog" aria-labelledby="exampleModallaptop1" aria-hidden="true">
                                                        <div class="modal-dialog modal-dialog-centered" role="document">
                                                            <div class="modal-content">
                                                                <div class="col-xl-12">
                                                                    <div class="card social-profile mb-0">
                                                                        <div class="card-body">
                                                                            <div class="social-img-wrap">
                                                                                <div class="social-img"><img th:src="${order.getSale().getAvatar()}" alt="profile"></div>
                                                                                <div class="edit-icon">
                                                                                    <svg>
                                                                                        <use th:href="@{assets/svg/icon-sprite.svg#profile-check}"></use>
                                                                                    </svg>
                                                                                </div>
                                                                            </div>
                                                                            <div class="social-details">
                                                                                <h5 class="mb-1">
                                                                                    <span th:text="${order.getSale().getName()}"></span>
                                                                                </h5>
                                                                                <span class="f-light" th:text="${order.getSale().getRole()}"></span>
                                                                                <ul class="social-follow">
                                                                                    <li>
                                                                                        <h5 class="mb-0">Email</h5><span class="f-light" th:text="${order.getSale().getEmail()}"></span>
                                                                                    </li>
                                                                                    <li>
                                                                                        <h5 class="mb-0">Phone</h5><span class="f-light" th:text="${order.getSale().getPhone()}"></span>
                                                                                    </li>
                                                                                    <li>
                                                                                        <h5 class="mb-0">Location</h5><span class="f-light" th:text="${order.getSale().getLocation()?.getAddress()}"></span>
                                                                                    </li>
                                                                                </ul>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <td th:utext="${order.getStatusCard()}"></td>
                                                    <td class="td-money" th:text="${order.getTotal()}"></td>
                                                    <td th:text="${order.getPaymentMethod()}"></td>
                                                    <td th:text="${order.getCreatedAt()?.toLocaleString()}"></td>
                                                    <td class="text-center">
                                                        <a th:data-id="${order.get_id()}" data-bs-toggle="modal" data-bs-target="#modal-transaction_detail" class="btn-show btn btn-pill btn-outline-info btn-air-info btn-sm m-r-5" type="button">View</a>
                                                    </td>
                                                </tr>
                                                </tbody>
                                                <tfoot>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="modal-transaction_detail" class="modal fade bd-example-modal-xl" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="myLargeModalLabel">Transaction Detail</h4>
                            <button class="btn-close py-0" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="invoice modal-toggle-wrapper">
                                <div>
                                    <div>
                                        <div class="table-responsive invoice-table" id="table">
                                            <table class="table table-bordered table-striped">
                                                <tbody id="tbody-transaction">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<div th:replace="theme/script :: script"></div>
<script th:src="@{/assets/js/datatable/datatables/jquery.dataTables.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/dataTables.buttons.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/jszip.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/buttons.colVis.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/pdfmake.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/vfs_fonts.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/dataTables.autoFill.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/dataTables.select.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/buttons.bootstrap4.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/buttons.html5.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/buttons.print.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/dataTables.bootstrap4.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/dataTables.responsive.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/responsive.bootstrap4.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/dataTables.keyTable.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/dataTables.colReorder.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/dataTables.fixedHeader.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/dataTables.rowReorder.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/dataTables.scroller.min.js}"></script>
<script th:src="@{/assets/js/datatable/datatable-extension/custom.js}"></script>
<script th:src="@{/assets/js/tooltip-init.js}"></script>
<script th:src="@{/assets/js/flat-pickr/flatpickr.js}"></script>
<script th:src="@{/assets/js/flat-pickr/custom-flatpickr.js}"></script>
<script th:src="@{/assets/js/chart/chartjs/chart.min.js}"></script>
<div th:replace="theme/app-script :: appScript"></div>
<script>
    formatVNDByClass('td-money')

    $('input[name="date"]').on('change', function () {
        if ($(this).attr('id') === 'iCustom') {
            $('#range-date').attr('hidden', false)
        } else {
            $('#range-date').attr('hidden', true)
        }
    })

    $('#btn-filter').on('click', function () {
        const checkedRadio = $('input[name="date"]:checked')
        if (checkedRadio.length === 0) {
            swal({
                title: "Error",
                text: 'Please choose a filter',
                icon: "error",
            })
            return
        }
        let date = checkedRadio.val()
        if (date === 'custom') {
            date = $('#range-date').val()
        }
        window.location.href = `/statistic/?date=${date}`
    })

    const date = getUrlParameter('date');
    if (date === 'yesterday') {
        $('#iYesterday').prop('checked', true);
    } else if (date === 'today') {
        $('#iToday').prop('checked', true);
    } else if (date === 'month') {
        $('#iMonth').prop('checked', true);
    } else if (date === 'week') {
        $('#iWeek').prop('checked', true);
    } else if (date.includes('to')) {
        $('#iCustom').prop('checked', true);
        const rangeDate = $('#range-date')
        rangeDate.attr('hidden', false)
        rangeDate.val(date)
    }

    $('.btn-show').on('click', function () {
        const id = $(this).data('id')
        $.ajax({
            url: `/api/order/${id}`,
            success: function (e) {
                const tbd = $('#tbody-transaction')
                tbd.empty()
                tbd.append(`
                        <tr>
                            <td class="item">
                                <h4 class="f-w-700 p-2 mb-0">Product Name</h4>
                            </td>
                            <td class="Rate">
                                <h4 class="f-w-700 p-2 mb-0">Price</h4>
                            </td>
                            <td class="Hours">
                                <h4 class="f-w-700 p-2 mb-0">Amount</h4>
                            </td>
                            <td class="subtotal">
                                <h4 class="f-w-700 p-2 mb-0">Sub-total</h4>
                            </td>
                        </tr>
                    `)
                let total = 0
                e.orderProducts.forEach(function (orderProduct) {
                    const subAmount = orderProduct.amount * orderProduct.price
                    total += subAmount
                    tbd.append(`
                            <tr>
                                <td>
                                    <label>${orderProduct.name}</label>
                                </td>
                                <td>
                                    <p class="itemtext">${formatVND(orderProduct.price)}</p>
                                </td>
                                <td>
                                    <p class="itemtext">${orderProduct.amount}</p>
                                </td>
                                <td>
                                    <p class="itemtext">${formatVND(subAmount)}</p>
                                </td>
                            </tr>
                        `)
                })
                tbd.append(`
                        <tr>
                            <td></td>
                            <td></td>
                            <td class="Rate">
                                <h4 class="f-w-700 mb-0 p-2">Total</h4>
                            </td>
                            <td class="payment">
                                <h4 class="f-w-700 mb-0 p-2">${formatVND(total)}</h4>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                            <td class="Rate">
                                <h4 class="f-w-700 mb-0 p-2">Receive</h4>
                            </td>
                            <td class="payment">
                                <h4 class="f-w-700 mb-0 p-2">${formatVND(e.order.receivedMoney)}</h4>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td></td>
                            <td class="Rate">
                                <h4 class="f-w-700 mb-0 p-2">Give back</h4>
                            </td>
                            <td class="payment">
                                <h4 class="f-w-700 mb-0 p-2">${formatVND(e.order.gaveBackMoney)}</h4>
                            </td>
                        </tr>

                    `)
            },
        })
    })
</script>
</body>
</html>